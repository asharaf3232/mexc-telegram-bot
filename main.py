# -*- coding: utf-8 -*-

import ccxt.async_support as ccxt
import pandas as pd
import pandas_ta as ta
import asyncio
import os
import logging
import json
import re
from telegram import Update, ReplyKeyboardMarkup
from telegram.constants import ParseMode
from telegram.ext import Application, CommandHandler, ContextTypes, MessageHandler, filters

## --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- ##

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨ÙˆØª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID')

if not all([TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID]):
    print("FATAL ERROR: Missing Telegram environment variables.")
    exit()

# 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
EXCHANGES_TO_SCAN = ['binance', 'okx', 'bybit', 'kucoin', 'gate']
TIMEFRAME = '15m'
SCAN_INTERVAL_SECONDS = 900
TRACK_INTERVAL_SECONDS = 120
PERFORMANCE_FILE = 'recommendations_log.csv'
SETTINGS_FILE = 'settings.json'

# --- ØªÙ‡ÙŠØ¦Ø© ---
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
bot_data = {"exchanges": {}, "last_signal_time": {}, "settings": {}}

## --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- ##
DEFAULT_SETTINGS = {
    "active_strategy": "momentum_breakout", "top_n_symbols_by_volume": 150, "concurrent_workers": 10,
    "market_regime_filter_enabled": True, "take_profit_percentage": 4.0, "stop_loss_percentage": 2.0,
    "trailing_sl_enabled": True, "trailing_sl_activate_percent": 2.0, "trailing_sl_percent": 1.5,
    "momentum_breakout": {"vwap_period": 14, "macd_fast": 12, "macd_slow": 26, "macd_signal": 9, "bbands_period": 20, "bbands_stddev": 2.0, "rsi_period": 14, "rsi_max_level": 68},
    "mean_reversion": {"bbands_period": 20, "bbands_stddev": 2.0, "rsi_period": 14, "rsi_oversold_level": 30}
}

def load_settings():
    if os.path.exists(SETTINGS_FILE):
        with open(SETTINGS_FILE, 'r') as f: bot_data["settings"] = json.load(f)
    else:
        bot_data["settings"] = DEFAULT_SETTINGS
        save_settings()
    logging.info("Settings loaded successfully.")

def save_settings():
    with open(SETTINGS_FILE, 'w') as f: json.dump(bot_data["settings"], f, indent=4)
    logging.info("Settings saved successfully.")

# --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª (Ù„Ø§ ØªØºÙŠÙŠØ±) ---
def analyze_momentum_breakout(df, params):
    # Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§
    pass
def analyze_mean_reversion(df, params):
    # Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§
    pass
STRATEGIES = {"momentum_breakout": analyze_momentum_breakout, "mean_reversion": analyze_mean_reversion}

# --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ø§ ØªØºÙŠÙŠØ±) ---
async def initialize_exchanges(): pass
async def aggregate_top_movers(): pass
async def worker(queue, results_list): pass
async def perform_scan(context: ContextTypes.DEFAULT_TYPE): pass
def log_recommendation(signal): pass
async def send_telegram_message(bot, signal_data, is_new=False, status=None, update_type=None): pass
async def track_open_trades(context: ContextTypes.DEFAULT_TYPE): pass
async def check_market_regime(): pass

# --- Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø®ÙÙŠØ© Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ ---
# (Ù„ØµÙ‚ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù‡Ù†Ø§)

## --- Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Ù„Ø§ ØªØºÙŠÙŠØ±) --- ##
main_menu_keyboard = [["ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "â„¹ï¸ Ù…Ø³Ø§Ø¹Ø¯Ø©"], ["ğŸ” ÙØ­Øµ ÙŠØ¯ÙˆÙŠ", "âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"]]
settings_menu_keyboard = [["ğŸ“ˆ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©", "ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±"], ["ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"]]
strategy_menu_keyboard = [["ğŸš€ Ø§Ù„Ø²Ø®Ù… ÙˆØ§Ù„Ø§Ù†Ø¯ÙØ§Ø¹", "ğŸ”„ Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…"], ["ğŸ”™ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"]]

## --- Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø± --- ##

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reply_markup = ReplyKeyboardMarkup(main_menu_keyboard, resize_keyboard=True)
    await update.message.reply_text("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªÙØ§Ø¹Ù„.", reply_markup=reply_markup)

async def show_settings_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reply_markup = ReplyKeyboardMarkup(settings_menu_keyboard, resize_keyboard=True)
    await update.message.reply_text("Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„Ù‡:", reply_markup=reply_markup)

async def show_strategy_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reply_markup = ReplyKeyboardMarkup(strategy_menu_keyboard, resize_keyboard=True)
    await update.message.reply_text("Ø§Ø®ØªØ± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", reply_markup=reply_markup)

async def show_set_parameter_instructions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    params_list = "\n".join([f"`{k}`" for k, v in bot_data["settings"].items() if not isinstance(v, dict)])
    await update.message.reply_text(
        f"Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ÙŠØ§Ø±ØŒ Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„ØµÙŠØºØ©:\n`Ø§Ø³Ù…_Ø§Ù„Ù…Ø¹ÙŠØ§Ø± = Ù‚ÙŠÙ…Ø©_Ø¬Ø¯ÙŠØ¯Ø©`\n\n*Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:*\n{params_list}",
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=ReplyKeyboardMarkup([["ğŸ”™ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"]], resize_keyboard=True)
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE): pass # (Ø§Ù„ÙƒÙˆØ¯ Ù„Ù… ÙŠØªØºÙŠØ±)
async def manual_scan_command(update: Update, context: ContextTypes.DEFAULT_TYPE): pass # (Ø§Ù„ÙƒÙˆØ¯ Ù„Ù… ÙŠØªØºÙŠØ±)
async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE): pass # (Ø§Ù„ÙƒÙˆØ¯ Ù„Ù… ÙŠØªØºÙŠØ±)


## --- (Ø¬Ø¯ÙŠØ¯) Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© --- ##

async def main_text_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø¹Ù† ØªÙˆØ¬ÙŠÙ‡ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©."""
    text = update.message.text
    
    # Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if text == "ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª": await stats_command(update, context)
    elif text == "â„¹ï¸ Ù…Ø³Ø§Ø¹Ø¯Ø©": await help_command(update, context)
    elif text == "ğŸ” ÙØ­Øµ ÙŠØ¯ÙˆÙŠ": await manual_scan_command(update, context)
    elif text == "âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª": await show_settings_menu(update, context)
    
    # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    elif text == "ğŸ“ˆ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©": await show_strategy_menu(update, context)
    elif text == "ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±": await show_set_parameter_instructions(update, context)
    elif text == "ğŸ”™ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©": await start_command(update, context)

    # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª
    elif text == "ğŸš€ Ø§Ù„Ø²Ø®Ù… ÙˆØ§Ù„Ø§Ù†Ø¯ÙØ§Ø¹":
        bot_data["settings"]["active_strategy"] = "momentum_breakout"
        save_settings()
        await update.message.reply_text("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© `Ø§Ù„Ø²Ø®Ù… ÙˆØ§Ù„Ø§Ù†Ø¯ÙØ§Ø¹`.")
        await show_settings_menu(update, context) # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    elif text == "ğŸ”„ Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…":
        bot_data["settings"]["active_strategy"] = "mean_reversion"
        save_settings()
        await update.message.reply_text("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© `Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…`.")
        await show_settings_menu(update, context) # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    elif text == "ğŸ”™ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª":
        await show_settings_menu(update, context)
        
    # Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±
    elif re.match(r"^\s*(\w+)\s*=\s*(.+)\s*$", text):
        match = re.match(r"^\s*(\w+)\s*=\s*(.+)\s*$", text)
        param, value_str = match.groups()
        settings = bot_data["settings"]
        if param in settings and not isinstance(settings[param], dict):
            try:
                current_value = settings[param]
                if isinstance(current_value, bool): new_value = value_str.lower() in ['true', '1', 'yes', 'on']
                elif isinstance(current_value, int): new_value = int(value_str)
                elif isinstance(current_value, float): new_value = float(value_str)
                else: new_value = value_str
                settings[param] = new_value
                save_settings()
                await update.message.reply_text(f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« `{param}` Ø¥Ù„Ù‰ `{new_value}`.")
            except ValueError:
                await update.message.reply_text(f"âŒ Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©.")
        else:
            await update.message.reply_text(f"âŒ Ø®Ø·Ø£: Ø§Ù„Ù…Ø¹ÙŠØ§Ø± `{param}` ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.")
    # else:
    #     await update.message.reply_text(" Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø±.")


async def post_init(application: Application): pass # (Ø§Ù„ÙƒÙˆØ¯ Ù„Ù… ÙŠØªØºÙŠØ±)
async def post_shutdown(application: Application): pass # (Ø§Ù„ÙƒÙˆØ¯ Ù„Ù… ÙŠØªØºÙŠØ±)

## --- Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- ##

if __name__ == '__main__':
    print("ğŸš€ Starting Interactive Trading Bot...")
    load_settings()
    
    application = (Application.builder().token(TELEGRAM_BOT_TOKEN).post_init(post_init).post_shutdown(post_shutdown).build())
    
    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ÙˆØ­ÙŠØ¯
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, main_text_handler))
    
    print("âœ… Bot is now running and polling for updates...")
    application.run_polling()

